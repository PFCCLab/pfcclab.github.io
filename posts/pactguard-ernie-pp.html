<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    
    <title>再也不靠人肉找合同&quot;坑&quot;：我的智能合同风险审查全流程落地实录 | 飞桨开源社区博客</title>
    <meta name="description" content="Wonderful stories from PaddlePaddle contributors">
    <meta name="generator" content="VitePress v1.6.4">
    <link rel="preload stylesheet" href="/assets/style.BId5x853.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.Cce2DscU.js"></script>
    <link rel="modulepreload" href="/assets/chunks/theme.DU_EuCD6.js">
    <link rel="modulepreload" href="/assets/chunks/framework.BRsttz9t.js">
    <link rel="modulepreload" href="/assets/posts_pactguard-ernie-pp.md.9blIBKHw.lean.js">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon-180x180.png">
    <link rel="mask-icon" href="/icons/mask-icon.svg" color="#ffffff">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7XR50K1YRK"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-7XR50K1YRK");</script>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
    <link rel="manifest" href="/manifest.webmanifest">
  </head>
  <body>
    <div id="app"><div class="antialiased dark:bg-neutral-900 min-h-screen"><div class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><nav class="flex justify-between items-center py-10 font-bold"><a class="text-xl" href="/" aria-label="飞桨开源社区博客"><img class="inline-block mr-2" style="width:120px;" alt="logo" src="/logo.png"><span class="hidden md:inline dark:text-white">飞桨开源社区博客</span></a><div class="text-sm text-gray-500 dark:text-white leading-5"><a class="hover:text-gray-700 dark:hover:text-gray-200" href="https://github.com/PFCCLab/blog" target="_blank" rel="noopener"><span class="hidden sm:inline">GitHub </span>Source</a><span class="mr-2 ml-2">·</span><a class="hover:text-gray-700 dark:hover:text-gray-200" href="/about.html" rel="noopener">About</a><span class="mr-2 ml-2">·</span><a class="hover:text-gray-700 dark:hover:text-gray-200" href="https://github.com/PFCCLab" target="_blank" rel="noopener">PFCCLab →</a></div></nav></div><main class="max-w-3xl mx-auto px-4 sm:px-6 xl:max-w-5xl xl:px-0"><article class="xl:divide-y xl:divide-gray-200 dark:xl:divide-slate-200/5"><header class="pt-6 xl:pb-10 space-y-1 text-center"><dl><dt class="sr-only">Published on</dt><dd class="text-base leading-6 font-medium text-gray-500 dark:text-gray-300"><time datetime="2025-12-01T12:00:00.000Z">2025年12月1日</time></dd></dl><h1 class="text-3xl leading-9 font-extrabold text-gray-900 dark:text-white tracking-tight sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">再也不靠人肉找合同&quot;坑&quot;：我的智能合同风险审查全流程落地实录</h1></header><div class="divide-y xl:divide-y-0 divide-gray-200 dark:divide-slate-200/5 xl:grid xl:grid-cols-4 xl:gap-x-10 pb-16 xl:pb-20" style="grid-template-rows:auto 1fr;"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 dark:xl:border-slate-200/5"><dt class="sr-only">Authors</dt><dd><ul class="flex flex-col pl-10 gap-y-5 md:grid md:grid-cols-2 md:gap-x-8 md:gap-y-6 md:pl-0 lg:grid-cols-3 xl:block xl:space-y-8"><!--[--><li class="flex items-center space-x-2"><img src="https://github.com/tjujingzong.png" alt="author image" class="w-10 h-10 rounded-full"><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-white">刘京宗</dd><dt class="sr-only">GitHub</dt><dd><a href="https://github.com/tjujingzong" target="_blank" rel="noopnener noreferrer" class="link">@tjujingzong</a></dd></dl></li><!--]--></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-slate-200/5 xl:pb-0 xl:col-span-3 xl:row-span-2"><div style="position:relative;" class="prose dark:prose-invert max-w-none pt-10 pb-8"><div><p>还在为了一份几十页的合同，熬夜逐条对照、担心漏掉关键条款吗？ 在大模型时代，这件事不该再靠人力硬扛。</p><p><strong>PactGuard-ERNIE-PP</strong> 是我在实践中打造的一套「<strong>智能合同审查与风险分析系统</strong>」。它并不是一个简单的“问问大模型就完了”的 Demo，而是一个真正能落地、能跑在生产环境里的<strong>工程级解决方案</strong>：</p><ul><li>能看 PDF、扫描件、图片等各种格式的合同；</li><li>能从杂乱的 OCR 结果里“拼回原始版面”，把风险条款精准高亮出来；</li><li>能在 LLM 返回“半残 JSON”的情况下自动修复，保证整条链路稳定运行。</li></ul><p>如果你：</p><ul><li>正在做 <strong>垂直领域 LLM 应用</strong>；</li><li>想搭一个 <strong>可复用的合同 / 文档审查框架</strong>；</li><li>或者只是好奇「一个工程化的 LLM 应用到底长什么样」</li></ul><p>这篇文章会把 PactGuard-ERNIE-PP 背后的架构、关键模块和踩坑经验，尽量讲清楚。</p><hr><h2 id="项目简介-它到底能帮你做什么" tabindex="-1">项目简介：它到底能帮你做什么？ <a class="header-anchor" href="#项目简介-它到底能帮你做什么" aria-label="Permalink to &quot;项目简介：它到底能帮你做什么？&quot;">​</a></h2><p>一句话概括：</p><blockquote><p><strong>PactGuard-ERNIE-PP 是一套基于 ERNIE 4.5 的智能合同审查系统，用自动化方式帮助识别法律 / 商业风险，并给出可执行的修改建议。</strong></p></blockquote><p>它的核心能力包括：</p><ul><li>🧾 <strong>多格式合同输入</strong>：支持 PDF、扫描件、图片等，自动走 OCR 流程；</li><li>🧠 <strong>LLM 深度分析</strong>：基于 ERNIE 4.5，对合同进行语义理解、风险识别和条款级分析；</li><li>📊 <strong>结构化风险报告</strong>：输出 JSON / Markdown 风险报告，支持统计信息和签约建议；</li><li>💡 <strong>可视化展示</strong>：在原始合同上直接高亮“有问题的条款”，风险一目了然。</li></ul><p>项目资源：</p><ul><li>🐙 GitHub 代码仓库：<a href="https://github.com/tjujingzong/PactGuard-ERNIE-PP" target="_blank" rel="noreferrer">点击访问</a></li><li>🚀 星河社区在线应用：<a href="https://aistudio.baidu.com/application/detail/104781" target="_blank" rel="noreferrer">立即体验</a></li><li>📓 星河社区 Notebook：<a href="https://aistudio.baidu.com/project/edit/9779934" target="_blank" rel="noreferrer">在线运行</a></li></ul><p><img src="/assets/demo-com.DtdbXD-W.png" alt="系统演示"></p><hr><h2 id="技术架构-一个可复用的-llm-合同审查骨架" tabindex="-1">技术架构：一个可复用的 LLM 合同审查骨架 <a class="header-anchor" href="#技术架构-一个可复用的-llm-合同审查骨架" aria-label="Permalink to &quot;技术架构：一个可复用的 LLM 合同审查骨架&quot;">​</a></h2><h3 id="整体架构图" tabindex="-1">整体架构图 <a class="header-anchor" href="#整体架构图" aria-label="Permalink to &quot;整体架构图&quot;">​</a></h3><p><img src="/assets/architecture-com.DUk3Z38T.png" alt="架构图"></p><p>从工程视角看，PactGuard-ERNIE-PP 本质上是一套「<strong>分层 + 解耦 + 可替换</strong>」的 LLM 应用架构。</p><h3 id="架构特点" tabindex="-1">架构特点 <a class="header-anchor" href="#架构特点" aria-label="Permalink to &quot;架构特点&quot;">​</a></h3><ol><li><p><strong>分层设计</strong></p><ul><li>UI 层、业务逻辑层、服务层、数据层清晰拆分，方便独立演进。</li><li>想换 UI 或换模型，只动对应层即可。</li></ul></li><li><p><strong>服务解耦</strong></p><ul><li>MCP 服务独立运行，通过 HTTP 接口通信。</li><li>OCR、LLM 等都可以视为“可拔插服务”。</li></ul></li><li><p><strong>可扩展性</strong></p><ul><li>LLM 和 OCR 服务都通过配置切换： <ul><li>你可以在 ERNIE、其他大模型之间切换；</li><li>也可以替换 OCR 引擎，而不动上层逻辑。</li></ul></li></ul></li><li><p><strong>容错机制</strong></p><ul><li>支持缓存、重试、降级：出问题时尽量“自动兜底”，而不是让用户直面报错。</li></ul></li></ol><hr><h2 id="合同处理主流程-从上传到结果落盘" tabindex="-1">合同处理主流程：从上传到结果落盘 <a class="header-anchor" href="#合同处理主流程-从上传到结果落盘" aria-label="Permalink to &quot;合同处理主流程：从上传到结果落盘&quot;">​</a></h2><p>在整个系统里，<strong>工作流引擎 <code>contract_workflow.py</code> 是真正的“中枢神经”</strong>。 可以把它理解为一条从「原始合同」到「结构化风险报告」的流水线：</p><p><img src="/assets/flowwork-compress2.DvbTY6hE.png" alt="流程图"></p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ContractWorkflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, contract_path: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1. 文档解析：调用 MCP / OCR 等服务，拿到结构化文本</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        parsed_document </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._parse_document(contract_path)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2. 风险分析：法律风险 + 商业风险 + 统计信息</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        risks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._analyze_risks(parsed_document)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 3. 建议生成：综合所有风险点输出签约建议与修改意见</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        suggestions </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._generate_suggestions(risks)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 4. 结果整合：计算文件哈希、补充元数据并写入 JSON / Markdown</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        final_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">._integrate_results(parsed_document, risks, suggestions)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> final_result</span></span></code></pre></div><p>在 UI 侧：</p><ul><li><code>ui_workflow.py</code> 接收用户上传的合同和配置；</li><li>调用 <code>ui_workflow_processor.py</code> 中的 <code>process_contract_workflow()</code>；</li><li>再把 <code>ContractWorkflow</code> 的执行结果同步到 Streamlit 会话状态，用于前端展示与下载。</li></ul><p><strong>一句话：工作流引擎负责「怎么跑」，UI 负责「怎么让用户看到」。</strong></p><hr><h2 id="模块职责清单-每个文件只做一件事" tabindex="-1">模块职责清单：每个文件只做一件事 <a class="header-anchor" href="#模块职责清单-每个文件只做一件事" aria-label="Permalink to &quot;模块职责清单：每个文件只做一件事&quot;">​</a></h2><p>为了避免“标题太碎”，这里直接整理成一个 <strong>模块职责表</strong>，方便你从工程角度快速扫描：</p><ul><li><p><strong>文档解析模块（<code>mcp_service.py</code>）</strong> 统一入口 <code>parse_contract()</code>：</p><ul><li>识别文件类型（PDF/DOCX/图片等）；</li><li>调用本地解析或在线 OCR；</li><li>将各种格式的合同 <strong>统一转换为结构化 JSON</strong>。</li></ul></li><li><p><strong>OCR 工具模块（<code>ui_ocr_utils.py</code>）</strong></p><ul><li>封装 PP-StructureV3 在线 OCR 调用，实现 <strong>版面恢复</strong>（段落、表格、坐标等）；</li><li>提供 <code>find_text_positions_in_json()</code> 等工具函数，为后续风险高亮提供坐标数据。</li></ul></li><li><p><strong>工作流引擎（<code>contract_workflow.py</code>）</strong></p><ul><li>实现主流程 <code>run()</code> 及 <code>_parse_document()</code>、<code>_analyze_risks()</code>、<code>_generate_suggestions()</code>、<code>_integrate_results()</code> 等内部步骤；</li><li>负责调用 LLM、解析模型 JSON、组织最终输出文件，是整个系统的核心业务层。</li></ul></li><li><p><strong>UI 展示模块（<code>ui_workflow.py</code>）</strong></p><ul><li>基于 Streamlit 搭建交互界面；</li><li>支持文件上传、参数配置（模型选择、API Key 等）、进度展示；</li><li>负责“结果页面”的整体布局（原文高亮 + 风险卡片 + 统计信息）。</li></ul></li><li><p><strong>渲染模块（<code>ui_rendering.py</code>）</strong></p><ul><li>把 JSON 结果转换成可交互 HTML；</li><li>在原文中高亮风险条款，实现左右分栏预览、按风险等级过滤展示；</li><li>是“<strong>让分析结果变成用户体验</strong>”的关键一环。</li></ul></li><li><p><strong>工具模块（<code>ui_utils.py</code>）</strong></p><ul><li>提供缓存、文件管理、会话状态初始化等通用工具；</li><li>比如基于文件哈希的缓存键、历史结果加载等，大幅减少重复分析时的等待时间。</li></ul></li><li><p><strong>工作流处理器（<code>ui_workflow_processor.py</code>）</strong></p><ul><li>作为 UI 与工作流引擎之间的“胶水层”；</li><li>负责协调异步执行、进度更新、错误捕获和用户提示；</li><li>让前端用户感受到的是“平滑的一步步执行过程”，而不是冷冰冰的后台任务。</li></ul></li></ul><hr><h2 id="开发过程中的技术亮点与踩坑复盘" tabindex="-1">开发过程中的技术亮点与踩坑复盘 <a class="header-anchor" href="#开发过程中的技术亮点与踩坑复盘" aria-label="Permalink to &quot;开发过程中的技术亮点与踩坑复盘&quot;">​</a></h2><p>下面这几块，是我在开发过程中印象最深、也最值得复用到其他 LLM 项目里的经验。</p><h3 id="_1-版面恢复-从-ocr-的-碎片堆-到可交互的合同页面" tabindex="-1">1. 版面恢复：从 OCR 的“碎片堆”到可交互的合同页面 <a class="header-anchor" href="#_1-版面恢复-从-ocr-的-碎片堆-到可交互的合同页面" aria-label="Permalink to &quot;1. 版面恢复：从 OCR 的“碎片堆”到可交互的合同页面&quot;">​</a></h3><p>现实中的合同很多都是扫描件：</p><ul><li>有的被压成图片嵌在 PDF 里；</li><li>有的还带着各种水印、盖章、表格。</li></ul><p>要想在原文上高亮风险条款，首先要解决一个问题：</p><blockquote><p><strong>如何从 OCR 返回的一大坨嵌套 JSON 里，恢复出接近原始 PDF 的版面布局？</strong></p></blockquote><p>核心逻辑在 <code>ui_rendering.py</code> 的 <code>generate_html_layout()</code> 中：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> generate_html_layout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(json_result: Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any], issues: List[Dict]) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;基于 JSON 生成 HTML 版面恢复，并标注风险点&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 1. 解析 OCR / PP-StructureV3 返回的版面结果</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    layout_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json_result.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;layoutParsingResults&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [{}])[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">].get(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">        &quot;prunedResult&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 2. 提取文本元素：行文本 + 坐标 + 所属页码等</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    text_elements </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _extract_ocr_text_elements(layout_result)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # text_elements 结构示例：</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # [</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   {&quot;page_id&quot;: 0, &quot;text&quot;: &quot;合同编号：...&quot;, &quot;bbox&quot;: [x1, y1, x2, y2], &quot;block_id&quot;: 1},</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    #   ...</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # ]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 3. 将风险点根据文本内容或 block_id 映射到对应的文本元素</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    issue_map </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _build_issue_map_by_block_id(issues)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 4. 逐个元素生成绝对定位的 &lt;div&gt;，并根据风险等级上色</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    html_blocks </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> elem </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> text_elements:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        block_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> elem.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        related_issues </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> issue_map.get(block_id, [])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        risk_level </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _get_max_risk_level(related_issues)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        style </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _build_style_from_bbox(elem[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;bbox&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], risk_level)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        content </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _escape_html(elem[</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;text&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        html_blocks.append(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;&lt;div class=&quot;ocr-text ocr-risk-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">risk_level</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot; style=&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">style</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&gt;&#39;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">content</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">            &quot;&lt;/div&gt;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 5. 包装成完整 HTML 页面（包含背景、样式和脚本）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _wrap_as_full_html_page(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.join(html_blocks))</span></span></code></pre></div><p>而为了在 OCR 的复杂 JSON 结构中准确找到「某个条款对应的坐标」，<code>ui_ocr_utils.py</code> 里实现了 <code>find_text_positions_in_json()</code>：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> find_text_positions_in_json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    clause_text: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, json_result: Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; List[Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;通过文本匹配在 JSON 中查找条款的位置信息&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    layout_results </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json_result.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;layoutParsingResults&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, [])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    matches: List[Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> []</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layout_idx, layout_item </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> enumerate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(layout_results):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        pruned </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> layout_item.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prunedResult&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, {})</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 1. 从结构化结果中查找（parsing_res_list）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pruned.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;parsing_res_list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, []):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _normalize_text(block.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;text&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _is_clause_match(clause_text, text):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                matches.append(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        &quot;layout_index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: layout_idx,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        &quot;block_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: block.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        &quot;bbox&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: block.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block_bbox&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        &quot;source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;parsing_res_list&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # 2. 从整体 OCR 结果中查找（overall_ocr_res）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ocr_block </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pruned.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;overall_ocr_res&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, []):</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> line </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ocr_block.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;res&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, []):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                text </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _normalize_text(line.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;text&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _is_clause_match(clause_text, text):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    matches.append(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        {</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                            &quot;layout_index&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: layout_idx,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                            &quot;block_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: ocr_block.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;block_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                            &quot;bbox&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: line.get(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rec_boxes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                            &quot;source&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;overall_ocr_res&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">                    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> matches</span></span></code></pre></div><p><strong>这里的关键经验有两点：</strong></p><ol><li><p><strong>正确“读懂” OCR JSON 的层级结构</strong>：</p><ul><li><code>layoutParsingResults</code> → <code>prunedResult</code> → <code>parsing_res_list</code> / <code>overall_ocr_res</code>；</li><li>既要用结构化结果（更干净），又要用整体 OCR（更完整）。</li></ul></li><li><p><strong>充分利用坐标信息（<code>block_bbox</code>、<code>rec_boxes</code>）</strong>：</p><ul><li>不只是为了高亮，更是为了恢复“接近原始 PDF”的阅读体验。</li></ul></li></ol><p>这个版面恢复思路，只要稍作改造，就可以复用到 <strong>电子发票审查、合同比对、标书评审</strong> 等一系列场景。</p><hr><h3 id="_2-json-修复-和-大模型半残-json-握手言和" tabindex="-1">2. JSON 修复：和“大模型半残 JSON”握手言和 <a class="header-anchor" href="#_2-json-修复-和-大模型半残-json-握手言和" aria-label="Permalink to &quot;2. JSON 修复：和“大模型半残 JSON”握手言和&quot;">​</a></h3><p>真实场景里，大模型很少像教科书那样乖：</p><ul><li>多一个逗号、少一个引号、少一层大括号……</li><li><code>json.loads()</code> 直接报错，整个工作流就废了。</li></ul><p>为了解决这个问题，我在 <code>contract_workflow.py</code> 里给模型返回结果加了一层 <strong>自动修复的“缓冲层”</strong>：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _parse_model_json</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(self, content: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, context: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; Optional[Any]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;尝试解析模型返回的 JSON，失败时使用 json_repair 做容错&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 1. 基础清洗：去掉 Markdown 代码块包装、无关前后缀</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cleaned </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content.strip()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cleaned </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cleaned.replace(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;```json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).replace(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;```&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">).strip()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 2. 先尝试标准 JSON 解析（成功则直接返回）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json.loads(cleaned)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    except</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json.JSONDecodeError:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.warning(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">context</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 返回的 JSON 非严格格式，尝试使用 json_repair 进行修复&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # 3. 如果失败，再尝试使用 json_repair 自动修复</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repair_json </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">is</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.error(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;未检测到 json_repair 库，无法自动修复无效 JSON&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        repaired </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repair_json(cleaned, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ensure_ascii</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">False</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> json.loads(repaired)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    except</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Exception</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        logger.error(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;使用 json_repair 解析 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">context</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 结果失败: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(e)</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">; 原始内容片段: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cleaned[:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span></span></code></pre></div><p>这样设计带来的好处：</p><ul><li>正常情况下走 <code>json.loads()</code>，性能和安全性都好；</li><li>模型轻微“越界”时，通过 <code>json_repair</code> 自动纠偏；</li><li>即便修复失败，也能优雅地记录日志，而不是让整个流程直接崩掉。</li></ul><p><strong>这套模式可以直接拿去复用：</strong> 只要你的 LLM 返回 JSON，就很值得加一层这样的“自愈能力”。</p><hr><h3 id="_3-基于文件哈希的缓存-让同一份合同只分析一次" tabindex="-1">3. 基于文件哈希的缓存：让同一份合同只分析一次 <a class="header-anchor" href="#_3-基于文件哈希的缓存-让同一份合同只分析一次" aria-label="Permalink to &quot;3. 基于文件哈希的缓存：让同一份合同只分析一次&quot;">​</a></h3><p>在真实使用中，一个合同往往不仅会被上传一次：</p><ul><li>法务看一遍，商务再看一遍；</li><li>换个模型参数、换个风险偏好，还要再跑几次。</li></ul><p>如果每次都从头走 OCR + LLM，不仅浪费算力，用户体验也会很差。 因此在 <code>ui_utils.py</code> 里，我加了一套 <strong>基于文件哈希的缓存机制</strong>：</p><div class="language-python vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pathlib </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Path</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> typing </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Callable, Dict, Any</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> calc_file_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file_path: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, chunk_size: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">int</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1024</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;对文件内容做哈希，保证同内容同哈希、不同内容必然不同&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hashlib</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    h </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hashlib.sha256()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    with</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file_path, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;rb&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        while</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> True</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            chunk </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f.read(chunk_size)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> chunk:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">                break</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            h.update(chunk)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> h.hexdigest()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_cache_key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(file_path: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, model_name: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) -&gt; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    file_hash </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> calc_file_hash(file_path)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">file_hash</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">_</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">model_name</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">}</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">def</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> load_or_run_workflow</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cache_key: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, runner: Callable[[], Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]]) -&gt; Dict[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">str</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Any]:</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;&quot;&quot;如果缓存存在则直接返回结果，否则执行工作流并写入缓存&quot;&quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cached </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> load_from_cache(cache_key)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cached </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">is</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> not</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> None</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cached</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> runner()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    save_to_cache(cache_key, result)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result</span></span></code></pre></div><p>这个设计有几个值得注意的小点：</p><ol><li><p><strong>缓存键 = 文件内容哈希 + 模型配置</strong></p><ul><li>同一份合同在同一模型配置下，只分析一次；</li><li>换了文件或模型配置，就不会误用旧缓存。</li></ul></li><li><p><strong>天然幂等</strong></p><ul><li>文件内容不变，哈希一定不变；</li><li>重复上传不会引入冗余计算。</li></ul></li><li><p><strong>用户体验直观可感</strong></p><ul><li>第一次分析可能几分钟；</li><li>第二次打开同一份合同时，结果可以直接秒级加载。</li></ul></li></ol><hr><h2 id="写在最后-这套系统还能怎么用" tabindex="-1">写在最后：这套系统还能怎么用？ <a class="header-anchor" href="#写在最后-这套系统还能怎么用" aria-label="Permalink to &quot;写在最后：这套系统还能怎么用？&quot;">​</a></h2><p>如果你看到这里，不妨可以：</p><ul><li><strong>想要直接体验</strong>：可以先去星河社区在线应用试用一份自己的合同；</li><li><strong>想要二次开发 / 改造</strong>：可以从 GitHub 仓库把代码拉下来，把 OCR、LLM 替换成你自己的技术栈；</li><li><strong>想要在其他文档场景复用</strong>：例如标书审查、合规检查、发票核验，都可以用同样的“工作流 + 版面恢复 + JSON 容错 + 缓存”思路。</li></ul><p>非常感谢张晶老师在开发过程中给予我的系统性指导，帮助我从“能跑通”走向“能工程化落地”。</p><p>也感谢杨有志老师在星河社区部署阶段给的支持，让项目顺利上线并可被更多人使用。</p><p>很幸运能够参加启航计划第 6 期，这次实践也让我对“如何把 LLM 变成真正可落地的系统”有了更深的理解。 也期待未来能继续为 Paddle 社区贡献自己的力量。</p></div></div></div><footer class="text-sm font-medium leading-5 divide-y divide-gray-200 dark:divide-slate-200/5 xl:col-start-1 xl:row-start-2"><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Next Article </h2><div class="link"><a href="/posts/high-precision-rag-system">构建基于ERNIE与Milvus的多文档高精度分析与问答系统</a></div></div><div class="py-8"><h2 class="text-xs tracking-wide uppercase text-gray-500 dark:text-white"> Previous Article </h2><div class="link"><a href="/posts/decode-sparse-attention-method">【论文分享】| 应用于大模型推理 Decode 阶段的稀疏 Attention</a></div></div><div class="pt-8"><a class="link" href="/">← Back to the blog</a></div></footer></div></article></main></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"about.md\":\"CzQAAf4V\",\"index.md\":\"AYBfx0e1\",\"pages_1.md\":\"wccGEy_C\",\"pages_2.md\":\"CNyCU79V\",\"pages_3.md\":\"B2EUOUN_\",\"pages_4.md\":\"JDLWzQTr\",\"pages_5.md\":\"wVTJN5qg\",\"pages_6.md\":\"ajK8Xo7n\",\"pages_7.md\":\"D1V8X6Zv\",\"pages_8.md\":\"C9fPTFNT\",\"posts_2023-os-report.md\":\"KoqxymVZ\",\"posts_2024-summary.md\":\"BFc6O-qh\",\"posts_2025-3rd-sw-conf.md\":\"oYRo7W4-\",\"posts_2025wuzhen.md\":\"Dc_dInmo\",\"posts_attention-sharing-sirui.md\":\"CZuKocbE\",\"posts_attnsink-paper-sharing.md\":\"RrNa11ke\",\"posts_buaa-starter.md\":\"DZMcxZ08\",\"posts_build-ernie-websearch.md\":\"NXDkfuT1\",\"posts_ccf-pku.md\":\"DBv8vhzc\",\"posts_chengdu-kaiyuanshe.md\":\"BuU5nIAV\",\"posts_chuan-story.md\":\"UiGi40mG\",\"posts_context-parrel-sharing.md\":\"BIHMolvU\",\"posts_cosyvoice.md\":\"BzDq48dR\",\"posts_decode-sparse-attention-method.md\":\"Ck9FTHi3\",\"posts_deepseek-tech-visualized.md\":\"BKbTJj_v\",\"posts_ernie45-paddleocr-case.md\":\"RR0g2AWK\",\"posts_first-post.md\":\"DfLGbfoW\",\"posts_flashoverlap-paper-sharing.md\":\"DxZQIYNn\",\"posts_flux-paper-sharing.md\":\"BI5_0SX0\",\"posts_glcc-luqi.md\":\"DiK5hFCr\",\"posts_hackathon-5th-episode01.md\":\"Df0O2ch6\",\"posts_hackathon-5th-episode02.md\":\"DljLYSrV\",\"posts_hackathon-5th-episode03.md\":\"B8-h4PLM\",\"posts_hackathon-6th-summary.md\":\"CjII45CK\",\"posts_hackathon-7th-summary.md\":\"BZoGEYXn\",\"posts_high-precision-rag-system.md\":\"CfUn4ZYF\",\"posts_huanggua-story.md\":\"3fmStkaX\",\"posts_huangjiyi-story.md\":\"DnuzI-cZ\",\"posts_ijcai-2024-competition.md\":\"B2ssZ-R3\",\"posts_io-paper-sharing.md\":\"DaAgwrgf\",\"posts_japan-hackathon.md\":\"B4r6pLgQ\",\"posts_kv-cache-drop-for-llm-infer.md\":\"FlfjGRC8\",\"posts_kv-cache-overview.md\":\"BLQqMIXC\",\"posts_lightning-talks.md\":\"CkzvQk5M\",\"posts_ligoml-story.md\":\"DwUUSbET\",\"posts_limin-story.md\":\"Cq3bk9v5\",\"posts_loaf-sharing.md\":\"Cb6ZXW4C\",\"posts_lzj-sharing.md\":\"VfbU8rSL\",\"posts_magiattention-sharing.md\":\"9uhQAeai\",\"posts_medusa.md\":\"CafSgstt\",\"posts_megascale-infer-paper-sharing.md\":\"DdCevYFk\",\"posts_netmoe-paper-sharing.md\":\"CLmhz_8_\",\"posts_newcomers-manual.md\":\"2fGdj5Uh\",\"posts_newhardware-2nd-event.md\":\"DP8zlBFH\",\"posts_nknan-story.md\":\"ClIDCktw\",\"posts_outlier-in-llm-paper-sharing.md\":\"DxJIzetH\",\"posts_pactguard-ernie-pp.md\":\"9blIBKHw\",\"posts_paddle-debug-methods.md\":\"BGwMbwTc\",\"posts_paddle-pipeline-parallel.md\":\"BXrwKs5W\",\"posts_paddle-scnu.md\":\"CsOmY_uw\",\"posts_paddleocr-release.md\":\"BW1kPCNf\",\"posts_paddleocr-vl-for-manga.md\":\"Dw-Lu7qS\",\"posts_pfcc-36th.md\":\"7668E08h\",\"posts_pku-course-2025.md\":\"Bo1xw7zs\",\"posts_pku-course.md\":\"B3Zt9sAI\",\"posts_post-training-overview.md\":\"bo23EEX8\",\"posts_pytorch-conference-01.md\":\"B14UyS7F\",\"posts_sanbu-story.md\":\"BVuipAfQ\",\"posts_shanghai-event.md\":\"ApG0YjGd\",\"posts_shun-story.md\":\"Bbt17jzP\",\"posts_starter-camp-5th.md\":\"5mxEq-BX\",\"posts_starter-camp.md\":\"TdAP6itn\",\"posts_suzhou-kaifangyuanzi.md\":\"CCEtzRNL\",\"posts_swagger-deepseek-r1.md\":\"BLYovS4m\",\"posts_tao-story.md\":\"VncVwA3l\",\"posts_type-hints-project.md\":\"BYrNy-i6\",\"posts_vattention-paper-sharing.md\":\"CXLeYUSG\",\"posts_wangxin-story.md\":\"B1ojKWVC\",\"posts_wuxi-kaifangyuanzi.md\":\"DVani9MK\",\"posts_xdoctest-project.md\":\"D1YjEXRk\",\"posts_xdu-xjtu-os.md\":\"CF04UOFz\",\"posts_xian-event.md\":\"DSOIzACM\",\"posts_yanguohao-story.md\":\"Caxzgkds\",\"posts_yinfan-story.md\":\"BQD8IBpP\",\"posts_zhangyiqiao-story.md\":\"D5MUTeFE\",\"posts_zheng-story.md\":\"Brmo3hBv\",\"posts_zju-event.md\":\"CTI-BvwC\",\"posts_zju-se-os.md\":\"D4JHDafp\",\"posts_zuckerberg-letter-post.md\":\"CHMyePoL\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"zh-CN\",\"dir\":\"ltr\",\"title\":\"飞桨开源社区博客\",\"description\":\"Wonderful stories from PaddlePaddle contributors\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"postsPerPage\":10},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>