import{_ as l,c as e,m as T,a as Q,L as a,o as n}from"./chunks/framework.CcfPirFf.js";const s="/assets/ring-attention-principle-diagram.DcC1Mu3j.png",r="/assets/megatron-LM-load-balance-diagram1.CByzuXhb.png",o="/assets/megatron-LM-load-balance-diagram2._Loauq7e.png",m="/assets/striped-attention-load-balance-diagram.SUNT2cW5.png",i="/assets/disattention-load-balance-diagram.ezNGsHsu.png",d="/assets/ring-attention-communication-diagram.DWlQjD-O.png",g="/assets/attention2d-principle-diagram.DU55qH3G.png",p="/assets/attention2d-no-overlap-algorithm-diagram1.JWMGf8rC.png",h="/assets/attention2d-no-overlap-algorithm-diagram2.DAfZFTJE.png",H="/assets/attention2d-no-overlap-algorithm-diagram3.Dqk1y78m.png",u="/assets/attention2d-overlap-algorithm-diagram1.ayxdoRyz.png",L="/assets/attention2d-overlap-algorithm-diagram2.BQtUtr-O.png",c="/assets/attention2d-overlap-algorithm-diagram3.BcutvMKz.png",_="/assets/attention2d-experiment-result1.CEa4QZ9P.png",f="/assets/attention2d-experiment-result2.Cu8A7akd.png",x="/assets/ulysses-principle-diagram.C0y8atbj.png",M="/assets/usp-algorithm-diagram1.B8Bd8pNz.png",w="/assets/usp-algorithm-diagram2.B5LIktzF.png",Z="/assets/different-parallel-strategy-communication-diagram.AqTSS1Sw.png",v="/assets/usp-experiment-result.C4Ry4RFA.png",S3=JSON.parse('{"title":"【论文分享】｜ 大模型训练中的序列并行技术与优化策略","description":"","frontmatter":{"title":"【论文分享】｜ 大模型训练中的序列并行技术与优化策略","date":"2025-07-21T00:00:00.000Z","author":{"name":"谢浩阳","github":"starcrown001"},"category":"insights"},"headers":[],"relativePath":"posts/context-parrel-sharing.md","filePath":"posts/context-parrel-sharing.md"}'),D={name:"posts/context-parrel-sharing.md"},y={id:"mjx-f76a4b7"},S={class:"MathJax",jax:"SVG",style:{position:"relative"}},P={style:{"vertical-align":"-0.798ex"},xmlns:"http://www.w3.org/2000/svg",width:"34.919ex",height:"3.024ex",role:"img",focusable:"false",viewBox:"0 -983.7 15434 1336.5","aria-hidden":"true"},A={id:"mjx-ab04a5c"},b={class:"MathJax",jax:"SVG",style:{position:"relative"}},V={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"9.494ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 4196.4 1000","aria-hidden":"true"},C={id:"mjx-eabd41f"},j={class:"MathJax",jax:"SVG",style:{position:"relative"}},k={style:{"vertical-align":"-0.206ex"},xmlns:"http://www.w3.org/2000/svg",width:"3.629ex",height:"2.398ex",role:"img",focusable:"false",viewBox:"0 -969 1604 1060","aria-hidden":"true"},R={id:"mjx-c7c703"},N={class:"MathJax",jax:"SVG",style:{position:"relative"}},O={style:{"vertical-align":"-0.206ex"},xmlns:"http://www.w3.org/2000/svg",width:"3.629ex",height:"2.398ex",role:"img",focusable:"false",viewBox:"0 -969 1604 1060","aria-hidden":"true"},I={id:"mjx-e5244dc"},E={class:"MathJax",jax:"SVG",style:{position:"relative"}},X={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.6ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 5127 1000","aria-hidden":"true"},B={id:"mjx-854cc21"},q={class:"MathJax",jax:"SVG",style:{position:"relative"}},z={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"16.36ex",height:"2.758ex",role:"img",focusable:"false",viewBox:"0 -969 7231 1219","aria-hidden":"true"},G={id:"mjx-b84630e"},J={class:"MathJax",jax:"SVG",style:{position:"relative"}},F={style:{"vertical-align":"-0.667ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.74ex",height:"2.26ex",role:"img",focusable:"false",viewBox:"0 -704 1211.3 999","aria-hidden":"true"},K={id:"mjx-770e8a7"},U={class:"MathJax",jax:"SVG",style:{position:"relative"}},W={style:{"vertical-align":"-0.667ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.872ex",height:"2.213ex",role:"img",focusable:"false",viewBox:"0 -683 1269.3 978","aria-hidden":"true"},$={id:"mjx-a87b168"},Y={class:"MathJax",jax:"SVG",style:{position:"relative"}},Q3={style:{"vertical-align":"-0.667ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.27ex",height:"2.213ex",role:"img",focusable:"false",viewBox:"0 -683 1003.3 978","aria-hidden":"true"},t3={id:"mjx-ec67c11"},a3={class:"MathJax",jax:"SVG",style:{position:"relative"}},T3={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.385ex",height:"2.758ex",role:"img",focusable:"false",viewBox:"0 -969 5032 1219","aria-hidden":"true"},e3={id:"mjx-d758e06"},n3={class:"MathJax",jax:"SVG",style:{position:"relative"}},l3={style:{"vertical-align":"-0.65ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.782ex",height:"2.242ex",role:"img",focusable:"false",viewBox:"0 -704 1229.7 991.2","aria-hidden":"true"},s3={id:"mjx-05a6e9e"},r3={class:"MathJax",jax:"SVG",style:{position:"relative"}},o3={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"10.335ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 4568 1000","aria-hidden":"true"},m3={id:"mjx-20c13c4"},i3={class:"MathJax",jax:"SVG",style:{position:"relative"}},d3={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"29.232ex",height:"2.758ex",role:"img",focusable:"false",viewBox:"0 -969 12920.4 1219","aria-hidden":"true"},g3={id:"mjx-5e32c03"},p3={class:"MathJax",jax:"SVG",style:{position:"relative"}},h3={style:{"vertical-align":"-0.206ex"},xmlns:"http://www.w3.org/2000/svg",width:"10.565ex",height:"2.398ex",role:"img",focusable:"false",viewBox:"0 -969 4669.6 1060","aria-hidden":"true"},H3={id:"mjx-5c50004"},u3={class:"MathJax",jax:"SVG",style:{position:"relative"}},L3={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"15.971ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 7059 1000","aria-hidden":"true"},c3={id:"mjx-0931d7f"},_3={class:"MathJax",jax:"SVG",style:{position:"relative"}},f3={style:{"vertical-align":"-0.566ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.639ex",height:"2.262ex",role:"img",focusable:"false",viewBox:"0 -750 5144.4 1000","aria-hidden":"true"};function x3(M3,t,w3,Z3,v3,D3){return n(),e("div",null,[t[52]||(t[52]=T("",16)),Q("p",null,[t[4]||(t[4]=a("初始版本的 ring-attention 的单卡通信量，参考下图所示，为 ",-1)),Q("span",y,[Q("mjx-container",S,[(n(),e("svg",P,[...t[0]||(t[0]=[T("",1)])])),t[1]||(t[1]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mrow",{"data-mjx-texclass":"OPEN"},[Q("mo",{minsize:"1.2em",maxsize:"1.2em"},"(")]),Q("mi",null,"N"),Q("mo",null,"⋅"),Q("mi",null,"h"),Q("mi",null,"s"),Q("mo",null,"⋅"),Q("mstyle",{displaystyle:"false",scriptlevel:"0"},[Q("mfrac",null,[Q("mrow",null,[Q("mi",null,"P"),Q("mo",null,"−"),Q("mn",null,"1")]),Q("mi",null,"P")])]),Q("mo",null,"⋅"),Q("mstyle",{displaystyle:"false",scriptlevel:"0"},[Q("mfrac",null,[Q("mi",null,"N"),Q("mi",null,"P")])]),Q("mo",null,"⋅"),Q("mstyle",{displaystyle:"false",scriptlevel:"0"},[Q("mfrac",null,[Q("mn",null,"1"),Q("mi",null,"c")])]),Q("mrow",{"data-mjx-texclass":"CLOSE"},[Q("mo",{minsize:"1.2em",maxsize:"1.2em"},")")]),Q("mo",null,"="),Q("mi",null,"O"),Q("mstyle",{scriptlevel:"0"},[Q("mspace",{width:"-0.167em"})]),Q("mrow",{"data-mjx-texclass":"OPEN"},[Q("mo",{minsize:"1.2em",maxsize:"1.2em"},"(")]),Q("mstyle",{displaystyle:"false",scriptlevel:"0"},[Q("mfrac",null,[Q("mrow",null,[Q("msup",null,[Q("mi",null,"N"),Q("mn",null,"2")]),Q("mo",null,"⋅"),Q("mi",null,"h"),Q("mi",null,"s")]),Q("mrow",null,[Q("mi",null,"P"),Q("mo",null,"⋅"),Q("mi",null,"c")])])]),Q("mrow",{"data-mjx-texclass":"CLOSE"},[Q("mo",{minsize:"1.2em",maxsize:"1.2em"},")")])])],-1))])]),t[5]||(t[5]=a(" （hs 为 head size，N 为 seqlen，P 为设备数量，c 为 ring-attention 中的分块大小），其在每次外层迭代中都会重新 load 一遍完整的 K 、V 矩阵，引入了大量通信开销。而在 llama3 [9] 与 megatron 的部分实现中，每个设备在进行分块计算前都会对 K 、V 进行一次 all gather 操作一次性获取本设备所需的完整 K 、V 矩阵，以额外的内存开销与舍弃了计算通信 overlap 的代价降低了通信量，此时的单卡通信量为 ",-1)),Q("span",A,[Q("mjx-container",b,[(n(),e("svg",V,[...t[2]||(t[2]=[T("",1)])])),t[3]||(t[3]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"N"),Q("mo",null,"⋅"),Q("mi",null,"h"),Q("mi",null,"s"),Q("mo",{stretchy:"false"},")")])],-1))])]),t[6]||(t[6]=a(" 。ring-attention 通信量示意图见下。",-1))]),t[53]||(t[53]=Q("p",null,[Q("img",{src:d,alt:"ring-attention 通信量示意图",title:"ring-attention 通信量示意图"})],-1)),t[54]||(t[54]=Q("h3",{id:"_2-3-attention2d",tabindex:"-1"},[a("2.3 attention2D "),Q("a",{class:"header-anchor",href:"#_2-3-attention2d","aria-label":'Permalink to "2.3 attention2D"'},"​")],-1)),Q("p",null,[t[11]||(t[11]=a("在 ring-attention 中，由于只在 Q 维度上进行了并行，因此每个设备需要通信的 K/V 矩阵通信量并不会随着设备数的增加而减少。 为了解决这个问题，微软在 2025 年提出了 Attention2D[10]，其在 kv 维度上同样进行了切分与并行。给定 P 个设备，Attention2D 会把 attention 的处理过程划分为 ",-1)),Q("span",C,[Q("mjx-container",j,[(n(),e("svg",k,[...t[7]||(t[7]=[T("",1)])])),t[8]||(t[8]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msqrt",null,[Q("mi",null,"P")])])],-1))])]),t[12]||(t[12]=a(" * ",-1)),Q("span",R,[Q("mjx-container",N,[(n(),e("svg",O,[...t[9]||(t[9]=[T("",1)])])),t[10]||(t[10]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msqrt",null,[Q("mi",null,"P")])])],-1))])]),t[13]||(t[13]=a(" 的 grid 进行并行计算，由于同时在 kv 维度与 q 维度上进行了等分，该算法本身就带有负载均衡的特性。Attention2D 的原理示意图见下",-1))]),t[55]||(t[55]=T("",9)),Q("p",null,[t[36]||(t[36]=a("与 ring-attention 相比，attention2D 的方法虽然额外引入了 Q 矩阵的通信开销，但却在单层 attention 计算中把矩阵的通信开销的复杂度从 ",-1)),Q("span",I,[Q("mjx-container",E,[(n(),e("svg",X,[...t[14]||(t[14]=[T("",1)])])),t[15]||(t[15]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"B"),Q("mi",null,"N"),Q("mi",null,"M"),Q("mi",null,"H"),Q("mo",{stretchy:"false"},")")])],-1))])]),t[37]||(t[37]=a(" 降低为了 ",-1)),Q("span",B,[Q("mjx-container",q,[(n(),e("svg",z,[...t[16]||(t[16]=[T("",1)])])),t[17]||(t[17]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"B"),Q("mi",null,"N"),Q("mi",null,"M"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("msqrt",null,[Q("mi",null,"P")]),Q("mo",{stretchy:"false"},")")])],-1))])]),t[38]||(t[38]=a(" （B 为 batchsize，N 为序列长度，M 为头数，H 为 headdim，P 为设备数）。下面对内存复杂度进行讨论。在上文提到的 attention2D 的算法中，在前向计算时每个设备的单层网络的单个头持有的 Q、K、V 矩阵块 ",-1)),Q("span",G,[Q("mjx-container",J,[(n(),e("svg",F,[...t[18]||(t[18]=[T("",1)])])),t[19]||(t[19]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msub",null,[Q("mi",null,"Q"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mi",null,"g")])])])],-1))])]),t[39]||(t[39]=a(" 、 ",-1)),Q("span",K,[Q("mjx-container",U,[(n(),e("svg",W,[...t[20]||(t[20]=[T("",1)])])),t[21]||(t[21]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msub",null,[Q("mi",null,"K"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mi",null,"g")])])])],-1))])]),t[40]||(t[40]=a(" 、 ",-1)),Q("span",$,[Q("mjx-container",Y,[(n(),e("svg",Q3,[...t[22]||(t[22]=[T("",1)])])),t[23]||(t[23]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msub",null,[Q("mi",null,"V"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mi",null,"g")])])])],-1))])]),t[41]||(t[41]=a(" 占用内存的空间复杂度为 ",-1)),Q("span",t3,[Q("mjx-container",a3,[(n(),e("svg",T3,[...t[24]||(t[24]=[T("",1)])])),t[25]||(t[25]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"N"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("msqrt",null,[Q("mi",null,"P")])])],-1))])]),t[42]||(t[42]=a(" )。在一次 attention 计算完成后，当前设备在该层该头需要长期保有以供反向传播使用的矩阵块如 ",-1)),Q("span",e3,[Q("mjx-container",n3,[(n(),e("svg",l3,[...t[26]||(t[26]=[T("",1)])])),t[27]||(t[27]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("msub",null,[Q("mi",null,"Q"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mi",null,"p")])])])],-1))])]),t[43]||(t[43]=a(" 的空间复杂度为 ",-1)),Q("span",s3,[Q("mjx-container",r3,[(n(),e("svg",o3,[...t[28]||(t[28]=[T("",1)])])),t[29]||(t[29]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"N"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("mi",null,"P"),Q("mo",{stretchy:"false"},")")])],-1))])]),t[44]||(t[44]=a(" 。因此在整个模型训练过程中，峰值显存占用为单次计算占用与长期保有矩阵显存占用之和，其复杂度为 ",-1)),Q("span",m3,[Q("mjx-container",i3,[(n(),e("svg",d3,[...t[30]||(t[30]=[T("",1)])])),t[31]||(t[31]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"B"),Q("mi",null,"L"),Q("mi",null,"M"),Q("mi",null,"N"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("mi",null,"P"),Q("mo",null,"+"),Q("mi",null,"B"),Q("mi",null,"N"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("msqrt",null,[Q("mi",null,"P")]),Q("mo",{stretchy:"false"},")")])],-1))])]),t[45]||(t[45]=a(" （L 为层数）。当 ",-1)),Q("span",g3,[Q("mjx-container",p3,[(n(),e("svg",h3,[...t[32]||(t[32]=[T("",1)])])),t[33]||(t[33]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"L"),Q("mi",null,"M"),Q("mo",null,">"),Q("msqrt",null,[Q("mi",null,"P")])])],-1))])]),t[46]||(t[46]=a(" 的场合，其空间复杂度可简化为 ",-1)),Q("span",H3,[Q("mjx-container",u3,[(n(),e("svg",L3,[...t[34]||(t[34]=[T("",1)])])),t[35]||(t[35]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"B"),Q("mi",null,"L"),Q("mi",null,"M"),Q("mi",null,"N"),Q("mi",null,"H"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("mi",null,"P"),Q("mo",{stretchy:"false"},")")])],-1))])]),t[47]||(t[47]=a(" ，与 ring-attention 相同。",-1))]),t[56]||(t[56]=T("",7)),Q("p",null,[t[50]||(t[50]=a("ulysses 的单卡通信量相比优化后的 ring-attention 较少，为 ",-1)),Q("span",c3,[Q("mjx-container",_3,[(n(),e("svg",f3,[...t[48]||(t[48]=[T("",1)])])),t[49]||(t[49]=Q("mjx-assistive-mml",{unselectable:"on",display:"inline"},[Q("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[Q("mi",null,"O"),Q("mo",{stretchy:"false"},"("),Q("mi",null,"N"),Q("mrow",{"data-mjx-texclass":"ORD"},[Q("mo",null,"/")]),Q("mi",null,"P"),Q("mo",null,"∗"),Q("mi",null,"d"),Q("mo",{stretchy:"false"},")")])],-1))])]),t[51]||(t[51]=a(" ，但 ring-attention 实现了通信与计算的 overlap 的操作。此外， ring-attention 需要多次 launch kernel，而 ulysses 只用 launch 一次 attention kernel，可以减少 kernel launch 的开销。但需要注意的是，ulysses 可以并行的最大维度为 head 数量，在并行程度上相较于 ring-attention 有所不足。",-1))]),t[57]||(t[57]=T("",23))])}const P3=l(D,[["render",x3]]);export{S3 as __pageData,P3 as default};
